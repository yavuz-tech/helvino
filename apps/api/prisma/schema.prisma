// Prisma schema for Helvino API

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                    String         @id @default(cuid())
  key                   String         @unique
  siteId                String         @unique // Public identifier for widget embedding
  name                  String
  stripeCustomerId      String?        @unique
  stripeSubscriptionId  String?        @unique
  stripePriceId         String?
  billingStatus         String         @default("none") // none|trialing|active|past_due|canceled|unpaid|incomplete
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean        @default(false)
  billingEnforced       Boolean        @default(false)
  billingGraceDays      Int            @default(7)
  lastStripeEventAt     DateTime?
  lastStripeEventId     String?        // For webhook idempotency
  graceEndsAt           DateTime?
  billingLockedAt       DateTime?
  lastPaymentFailureAt  DateTime?
  lastBillingReconcileAt DateTime?
  lastBillingReconcileResult Json?
  trialEndsAt           DateTime?
  trialStartedAt        DateTime?
  firstConversationAt   DateTime?      // Conversion signal
  firstWidgetEmbedAt    DateTime?      // Conversion signal
  firstInviteSentAt     DateTime?      // Conversion signal
  // Widget health metrics (Step 11.35)
  widgetLoadsTotal         Int         @default(0)
  widgetLoadFailuresTotal  Int         @default(0)
  widgetDomainMismatchTotal Int        @default(0)
  lastMismatchHost          String?    // Last reported host that triggered domain mismatch (Step 11.68)
  lastMismatchAt            DateTime?  // When last domain mismatch occurred
  widgetRtBucketsJson      Json?       // Rolling histogram {buckets:[{max,count},...]}
  widgetRtTotalCount       Int         @default(0)
  lastWidgetSeenAt      DateTime?
  planKey               String         @default("free")
  planStatus            String         @default("inactive") // "active" | "inactive" | "past_due" | "canceled"
  allowedDomains        String[]       @default([])
  allowLocalhost        Boolean        @default(true) // Allow localhost/127.0.0.1 for development
  widgetEnabled         Boolean        @default(true)
  writeEnabled          Boolean        @default(true)
  aiEnabled             Boolean        @default(true)
  aiConfigJson          Json?          // AI bot configuration: systemPrompt, model, temperature, etc.
  aiProvider            String         @default("openai") // "openai" | "gemini" | "claude"
  currentMonthAIMessages Int          @default(0)
  aiMessagesLimit       Int            @default(100)      // FREE=100, STARTER=500, PRO=2000, ENTERPRISE=-1
  aiMessagesResetDate   DateTime       @default(now())
  primaryColor          String         @default("#0F5C5C")
  widgetName            String         @default("Brand Name")
  widgetSubtitle        String         @default("Default Subtitle")
  language              String         @default("en")
  launcherText          String?
  position              String         @default("right")
  messageRetentionDays  Int            @default(365)
  hardDeleteOnRetention Boolean        @default(false)
  lastRetentionRunAt    DateTime?
  extraConversationQuota Int           @default(0)
  extraMessageQuota     Int            @default(0)
  isActive              Boolean        @default(true)
  ownerUserId           String?        // FK to OrgUser who is the org owner (Step 11.39)
  createdVia            String         @default("admin") // "admin" | "self_serve"
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  conversations         Conversation[]
  messages              Message[]
  visitors              Visitor[]
  orgUsers              OrgUser[]
  usages                Usage[]
  operatingHours        OperatingHours?
  channelConfigs        ChannelConfig[]
  macros                Macro[]
  workflowRules         WorkflowRule[]
  slaPolicies           SlaPolicy[]
  chatPageConfig        ChatPageConfig?
  translationOverrides  TranslationOverride[]
  checkoutSessions      CheckoutSession[]
  promotionCodes        PromotionCode[]

  @@index([siteId])
  @@index([ownerUserId])
  @@map("organizations")
}

model CheckoutSession {
  id                  String       @id // Stripe checkout session id
  organizationId      String
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email               String
  stripeCustomerId    String?
  stripePriceId       String?
  planType            String
  amount              Int
  status              String       @default("started") // started | completed | abandoned
  promoCodeId         String?
  promoCode           PromotionCode? @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  createdAt           DateTime     @default(now())
  completedAt         DateTime?
  abandonedAt         DateTime?
  abandonedEmailSentAt DateTime?

  @@index([organizationId, status, createdAt])
  @@index([email, status, createdAt])
  @@map("checkout_sessions")
}

model PromotionCode {
  id                    String       @id @default(cuid())
  organizationId        String?
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  code                  String       @unique
  title                 String
  percentOff            Int
  stripeCouponId        String       @unique
  stripePromotionCodeId String       @unique
  active                Boolean      @default(true)
  customerEmail         String?
  checkoutSessionId     String?
  maxRedemptions        Int?
  expiresAt             DateTime?
  createdBy             String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  checkoutSessions      CheckoutSession[]

  @@index([organizationId, active, createdAt])
  @@index([customerEmail, active])
  @@map("promotion_codes")
}

model Plan {
  id                        String  @id @default(cuid())
  key                       String  @unique // "free" | "pro" | "business"
  name                      String
  stripePriceId             String? @unique // Stripe Price ID mapping
  monthlyPriceUsd           Int?
  maxConversationsPerMonth  Int
  maxMessagesPerMonth       Int
  maxAgents                 Int

  @@map("plans")
}

model Usage {
  id                    String   @id @default(cuid())
  orgId                 String
  organization          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  monthKey              String   // YYYY-MM
  conversationsCreated  Int      @default(0)
  messagesSent          Int      @default(0)
  m1Count               Int      @default(0) // Human conversations (agent handoff/send) — Step 11.68
  m2Count               Int      @default(0) // AI assisted/resolved responses
  m3Count               Int      @default(0) // Automations reached visitors (unique per period)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([orgId, monthKey])
  @@index([orgId])
  @@map("usages")
}

// M3 dedupe: one row per visitor per period (Step 11.68)
model UsageVisitor {
  id         String   @id @default(cuid())
  orgId      String
  periodKey  String   // YYYY-MM
  visitorKey String   // visitorId or anonId
  source     String   @default("M3")
  createdAt  DateTime @default(now())

  @@unique([orgId, periodKey, visitorKey])
  @@index([orgId, periodKey])
  @@map("usage_visitors")
}

// Domain mismatch audit log (Step 11.68)
model DomainMismatchEvent {
  id                      String   @id @default(cuid())
  orgId                   String
  reportedHost            String
  allowedDomainsSnapshot  Json     // string[] at time of event
  userAgent               String?
  referrerHost            String?
  createdAt               DateTime @default(now())

  @@index([orgId])
  @@index([orgId, createdAt(sort: Desc)])
  @@map("domain_mismatch_events")
}

model Visitor {
  id             String         @id @default(cuid())
  orgId          String
  organization   Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  visitorKey     String         // visitorId from x-visitor-id header
  firstSeenAt    DateTime       @default(now())
  lastSeenAt     DateTime       @default(now())
  userAgent      String?
  ip             String?
  country        String?        // ISO 3166-1 alpha-2 (e.g. "TR", "US", "DE")
  city           String?
  currentPage    String?
  referrer       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  conversations  Conversation[]

  @@unique([orgId, visitorKey])
  @@index([orgId])
  @@index([visitorKey])
  @@index([orgId, lastSeenAt])
  @@map("visitors")
}

model Conversation {
  id                   String              @id
  orgId                String
  organization         Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  visitorId            String?
  visitor              Visitor?            @relation(fields: [visitorId], references: [id], onDelete: SetNull)
  createdAt            DateTime
  updatedAt            DateTime
  messageCount         Int                 @default(0)
  status               String              @default("OPEN") // OPEN | CLOSED
  assignedToOrgUserId  String?
  assignedTo           OrgUser?            @relation(fields: [assignedToOrgUserId], references: [id], onDelete: SetNull)
  closedAt             DateTime?
  hasUnreadFromUser    Boolean             @default(false) // true = last msg from customer, list shows unread first
  messages             Message[]
  notes                ConversationNote[]

  @@index([orgId])
  @@index([orgId, updatedAt])
  @@index([orgId, id])
  @@index([visitorId])
  @@index([orgId, status])
  @@index([orgId, hasUnreadFromUser])
  @@index([assignedToOrgUserId])
  @@map("conversations")
}

model ConversationNote {
  id               String       @id @default(cuid())
  orgId            String
  conversationId   String
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  authorOrgUserId  String
  author           OrgUser      @relation(fields: [authorOrgUserId], references: [id], onDelete: Cascade)
  body             String       @db.Text
  createdAt        DateTime     @default(now())

  @@index([orgId, conversationId, createdAt])
  @@index([conversationId])
  @@map("conversation_notes")
}

model Message {
  id             String       @id
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  orgId          String
  organization   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role           String
  content        String       @db.Text
  timestamp      DateTime

  // Enhanced AI tracking
  isAIGenerated  Boolean      @default(false)
  aiProvider     String?      // "openai" | "gemini" | "claude"
  aiModel        String?      // "gpt-4o-mini", "gemini-1.5-flash", etc.
  aiTokensUsed   Int?         // Total tokens (input + output)
  aiCost         Decimal?     @db.Decimal(10, 6) // Cost in USD
  aiResponseTime Int?         // Response time in milliseconds

  @@index([conversationId])
  @@index([orgId])
  @@index([orgId, conversationId, timestamp(sort: Desc)])
  @@map("messages")
}

model AdminUser {
  id             String   @id @default(cuid())
  email          String   @unique
  passwordHash   String
  role           String   // "owner" | "admin" | "agent"
  mfaEnabled     Boolean  @default(false)
  mfaSecret      String?  // encrypted TOTP secret
  mfaVerifiedAt  DateTime?
  backupCodesHash String? // JSON array of hashed backup codes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([email])
  @@map("admin_users")
}

model OrgUser {
  id              String       @id @default(cuid())
  orgId           String
  email           String       @unique
  passwordHash    String
  role            String       // "owner" | "admin" | "agent"
  isActive        Boolean      @default(true)
  emailVerifiedAt DateTime?    // null = not verified (Step 11.36)
  lastLoginAt     DateTime?
  mfaEnabled      Boolean      @default(false)
  mfaSecret       String?      // encrypted TOTP secret
  mfaVerifiedAt   DateTime?
  backupCodesHash String?      // JSON array of hashed backup codes
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  invitesCreated  PortalInvite[] @relation("InviteCreator")
  passwordResetTokens PasswordResetToken[]
  portalSessions  PortalSession[]
  assignedConversations Conversation[]
  conversationNotes ConversationNote[]

  @@index([orgId])
  @@index([email])
  @@map("org_users")
}

model PortalInvite {
  id                   String    @id @default(cuid())
  orgId                String
  email                String
  role                 String    // "admin" | "agent"
  tokenHash            String    @unique
  expiresAt            DateTime
  acceptedAt           DateTime?
  createdAt            DateTime  @default(now())
  createdByPortalUserId String
  createdBy            OrgUser   @relation("InviteCreator", fields: [createdByPortalUserId], references: [id], onDelete: Cascade)

  @@unique([orgId, email])
  @@index([orgId])
  @@index([tokenHash])
  @@map("portal_invites")
}

model PasswordResetToken {
  id          String    @id @default(cuid())
  orgUserId   String
  orgUser     OrgUser   @relation(fields: [orgUserId], references: [id], onDelete: Cascade)
  hashedToken String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([hashedToken])
  @@index([orgUserId])
  @@map("password_reset_tokens")
}

model PortalSession {
  id          String    @id @default(cuid())
  orgUserId   String
  orgUser     OrgUser   @relation(fields: [orgUserId], references: [id], onDelete: Cascade)
  tokenHash   String    @unique
  createdAt   DateTime  @default(now())
  lastSeenAt  DateTime  @default(now())
  revokedAt   DateTime?
  ip          String?
  userAgent   String?

  @@index([orgUserId])
  @@index([tokenHash])
  @@map("portal_sessions")
}

model TrustedDevice {
  id             String   @id @default(cuid())
  userId         String   // OrgUser or AdminUser id
  userType       String   // "portal" | "admin"
  userAgentHash  String
  label          String?
  trusted        Boolean  @default(false)
  firstSeenAt    DateTime @default(now())
  lastSeenAt     DateTime @default(now())
  lastIp         String?
  userAgentRaw   String?  // Truncated UA for display

  @@unique([userId, userType, userAgentHash])
  @@index([userId, userType])
  @@map("trusted_devices")
}

model AuditLog {
  id        String   @id @default(cuid())
  orgId     String
  actor     String   // admin email, "system", "webhook"
  action    String   // e.g. "usage.reset", "quota.grant", "billing.lock", "billing.unlock", "webhook.state_change"
  details   Json?
  createdAt DateTime @default(now())

  @@index([orgId, createdAt])
  @@map("audit_logs")
}

model AccountRecoveryRequest {
  id          String    @id @default(cuid())
  userType    String    // "admin" | "portal"
  userId      String
  email       String
  reason      String    @db.Text
  status      String    @default("pending") // "pending" | "approved" | "rejected" | "expired"
  requestedAt DateTime  @default(now())
  expiresAt   DateTime
  resolvedAt  DateTime?
  resolvedBy  String?   // admin email who resolved
  ip          String?
  userAgent   String?

  @@index([userId, userType])
  @@index([status])
  @@map("account_recovery_requests")
}

model WebAuthnCredential {
  id           String   @id @default(cuid())
  userType     String   // "admin" | "portal"
  userId       String
  credentialId String   @unique // base64url encoded credential ID
  publicKey    String   @db.Text // base64url encoded public key (COSE → SubjectPublicKeyInfo)
  counter      Int      @default(0)
  transports   String?  // JSON array e.g. ["usb","ble","nfc","internal"]
  aaguid       String?  // authenticator attestation GUID
  nickname     String?
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime @default(now())

  @@index([userId, userType])
  @@index([credentialId])
  @@map("webauthn_credentials")
}

model WebAuthnChallenge {
  id        String    @id @default(cuid())
  userType  String    // "admin" | "portal"
  userId    String?   // null for dummy/anonymous challenges
  challenge String    @unique // base64url challenge string
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  ip        String?
  userAgent String?

  @@index([userId, userType])
  @@index([challenge])
  @@map("webauthn_challenges")
}

model Notification {
  id           String    @id @default(cuid())
  orgId        String
  userId       String?   // null => org-wide; if set, only that user sees it
  severity     String    @default("INFO") // INFO | WARN | CRITICAL
  type         String    // SECURITY | WIDGET_HEALTH | BILLING | SYSTEM (category)
  sourceAction String?   // Optional traceability: "mfa.enabled", "billing.locked", etc.
  titleKey     String    // i18n key
  bodyKey      String    // i18n key
  metaJson     Json?
  createdAt    DateTime  @default(now())
  readAt       DateTime? // DEPRECATED — per-user read state in NotificationRead

  reads NotificationRead[]

  @@index([orgId, createdAt])
  @@index([orgId, userId, readAt])
  @@map("notifications")
}

model NotificationRead {
  id             String       @id @default(cuid())
  notificationId String
  orgUserId      String
  readAt         DateTime     @default(now())

  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([notificationId, orgUserId])
  @@index([orgUserId, readAt])
  @@index([notificationId])
  @@map("notification_reads")
}

model NotificationPreference {
  id              String   @id @default(cuid())
  orgUserId       String   @unique
  securityEnabled Boolean  @default(true)
  billingEnabled  Boolean  @default(true)
  widgetEnabled   Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("notification_preferences")
}

model EmergencyAccessToken {
  id          String    @id @default(cuid())
  userId      String
  userType    String    // "admin" | "portal"
  tokenHash   String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
  cooldownUntil DateTime // cannot regenerate until this date

  @@index([userId, userType])
  @@index([tokenHash])
  @@map("emergency_access_tokens")
}

model WidgetSettings {
  id             String       @id @default(cuid())
  orgId          String       @unique
  primaryColor   String       @default("#0F5C5C")
  position       String       @default("right") // "right" | "left"
  launcher       String       @default("bubble") // "bubble" | "icon"
  welcomeTitle   String       @default("Welcome") @db.VarChar(60)
  welcomeMessage String       @default("How can we help you today?") @db.VarChar(240)
  brandName      String?      @db.VarChar(40)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([orgId])
  @@map("widget_settings")
}

model OperatingHours {
  id                  String              @id @default(cuid())
  orgId               String              @unique
  timezone            String              @default("UTC")
  enabled             Boolean             @default(false)
  offHoursAutoReply   Boolean             @default(false)
  offHoursReplyText   String?             @db.Text
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  organization        Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  days                OperatingHoursDay[]

  @@index([orgId])
  @@map("operating_hours")
}

model OperatingHoursDay {
  id                String          @id @default(cuid())
  operatingHoursId  String
  weekday           Int             // 0=Sunday ... 6=Saturday
  isOpen            Boolean         @default(false)
  startTime         String?         // HH:mm
  endTime           String?         // HH:mm
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  operatingHours    OperatingHours  @relation(fields: [operatingHoursId], references: [id], onDelete: Cascade)

  @@unique([operatingHoursId, weekday])
  @@index([operatingHoursId])
  @@map("operating_hours_days")
}

model ChannelConfig {
  id            String       @id @default(cuid())
  orgId         String
  channelType   String       // live_chat | email | whatsapp | facebook | instagram
  enabled       Boolean      @default(false)
  settingsJson  Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, channelType])
  @@index([orgId])
  @@map("channel_configs")
}

model Macro {
  id            String       @id @default(cuid())
  orgId         String
  title         String
  content       String       @db.Text
  enabled       Boolean      @default(true)
  createdById   String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, enabled])
  @@map("macros")
}

model WorkflowRule {
  id            String       @id @default(cuid())
  orgId         String
  name          String
  trigger       String       // message_created | conversation_created | conversation_closed
  enabled       Boolean      @default(true)
  conditionsJson Json?
  actionsJson   Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, enabled])
  @@map("workflow_rules")
}

model SlaPolicy {
  id                     String       @id @default(cuid())
  orgId                  String
  name                   String       @default("Default SLA")
  enabled                Boolean      @default(false)
  firstResponseMinutes   Int          @default(15)
  resolutionMinutes      Int          @default(480)
  warnThresholdPercent   Int          @default(80)
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  organization           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
  @@map("sla_policies")
}

model ChatPageConfig {
  id                   String       @id @default(cuid())
  orgId                String       @unique
  title                String       @default("Chat with us")
  subtitle             String       @default("We reply as soon as possible")
  placeholder          String       @default("Write your message...")
  showAgentAvatars     Boolean      @default(true)
  showOperatingHours   Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  organization         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("chat_page_configs")
}

model TranslationOverride {
  id            String       @id @default(cuid())
  orgId         String
  locale        String
  translationKey String
  value         String       @db.Text
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, locale, translationKey])
  @@index([orgId, locale])
  @@map("translation_overrides")
}
