---
description: Pending tasks and current project status — read this to know what needs to be done
globs: 
alwaysApply: true
---

# Helvino — Pending Tasks & Current Status

## IN PROGRESS: Abandoned Checkout + Promotion Code System

### Current Implementation Status (Updated)

#### Done
- `CheckoutSession` and `PromotionCode` models are present in `apps/api/prisma/schema.prisma`.
- Migration exists for checkout/promo foundation:
  - `apps/api/prisma/migrations/20260210083000_add_checkout_abandon_and_promo/migration.sql`
- Checkout tracking is implemented in Stripe utility:
  - `apps/api/src/utils/stripe.ts` -> `createCheckoutSession()` upserts `CheckoutSession` with `status: "started"`.
- Checkout completion is wired in webhook:
  - `apps/api/src/routes/stripe-webhook.ts` handles `checkout.session.completed`.
  - Matching `CheckoutSession` is updated to `status: "completed"` with `completedAt`.
- Abandoned checkout job is implemented:
  - `apps/api/src/jobs/checkAbandonedCheckouts.ts`
  - Marks old `started` sessions as `abandoned`, sends email, records audit.
  - Registered in `apps/api/src/index.ts` via cron (`* * * * *`).
- Abandoned checkout email flow exists:
  - Sender: `apps/api/src/emails/send-abandoned-email.ts`
  - Template provider: `apps/api/src/utils/email-templates.ts` -> `getAbandonedCheckoutEmail(...)`
- Admin promo code APIs exist in:
  - `apps/api/src/routes/internal-admin.ts`
  - `GET /internal/promo-codes`
  - `POST /internal/promo-codes`
  - `PATCH /internal/promo-codes/:id`
- Admin promo UI section exists in:
  - `apps/web/src/app/dashboard/settings/page.tsx`
- Checkout supports promo usage in Stripe:
  - `apps/api/src/utils/stripe.ts` uses `allow_promotion_codes: true`.

#### Partially Done / Needs Validation
- Stripe-side coupon/promotion code sync is implemented, but should be validated in real Stripe environment for all edge cases (usage limits, expiration, inactive codes).
- End-to-end checkout-abandon-recovery flow needs explicit integration test coverage.
- Production migration/application status should be confirmed per environment (local code has migration; deployment state may vary).

#### Remaining Work (Actionable)
1. Add or expand automated integration tests for:
   - checkout start -> `CheckoutSession(status="started")`
   - webhook completion -> `status="completed"`
   - abandoned job -> `status="abandoned"` + promo creation + email send
2. Validate full Stripe behavior with live/test keys:
   - promotion code attach, checkout acceptance, webhook attribution.
3. Optional cleanup:
   - review legacy abandoned email artifacts (`apps/api/src/emails/abandoned-checkout.ts`, `apps/api/src/emails/abandonedCheckout.tsx`) and keep only the canonical path.

## LATEST COMPLETED (Security/Tech Debt)

- Strong password validation added in API (`validatePasswordStrength`) and enforced on signup/reset/change/invite accept flows.
- CORS and domain allowlist hardening completed:
  - empty allowlist blocked in production,
  - localhost-only behavior in development for empty lists,
  - wildcard allowlist entries blocked/ignored.
- Non-essential `console.log` cleanup completed across API/Web; startup-level logs retained.

## COMPLETED FEATURES (for reference)
- Full portal UI overhaul (Tidio/Intercom level)
- Stripe billing (checkout, webhooks, invoices, portal)
- Team management with premium UI
- Security page with MFA/WebAuthn
- Audit logs with premium UI
- Settings suite (15+ sub-pages)
- i18n system (EN/TR/ES) with build-time parity
- Dev server watchdog with auto-recovery
- Floating widget bubble preview
- Premium toast notifications
- Email templates (invite, reset, verify, recovery)
- Multi-currency display
